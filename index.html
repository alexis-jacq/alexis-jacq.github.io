<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Paper Tracker</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        .container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        
        /* Sidebar (Tree) */
        .sidebar { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 80vh; overflow-y: auto; }
        .tree-item { margin-left: 15px; border-left: 1px solid #ddd; padding-left: 10px; margin-top: 5px; }
        .folder { font-weight: bold; cursor: pointer; color: #475569; }
        .folder::before { content: "üìÅ "; }
        .file { cursor: pointer; color: var(--primary); font-size: 0.9em; margin-top: 4px; display: block; }
        .file:hover { text-decoration: underline; }

        /* Main Content */
        .main { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input, textarea, select { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        button.secondary { background: #64748b; }
        button.danger { background: #ef4444; }
        button:hover { opacity: 0.9; }
        
        /* API Key Modal */
        #api-section { margin-bottom: 20px; padding: 10px; background: #e0f2fe; border-radius: 4px; display: none; }
        
        .paper-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 15px; border-radius: 6px; }
        .citation-box { background: #f1f5f9; padding: 10px; font-family: monospace; font-size: 0.85em; white-space: pre-wrap; }
        .tag { display: inline-block; background: #e2e8f0; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>üìö Scientific Paper Tracker</h1>
    
    <div style="text-align: right; margin-bottom: 10px;">
        <button class="secondary" onclick="toggleApiSettings()" style="font-size: 0.8em;">‚öôÔ∏è Configure AI</button>
    </div>
    <div id="api-section">
        <p><small>Enter a Gemini API Key to enable auto-summarization. (Stored locally in browser)</small></p>
        <input type="password" id="apiKey" placeholder="Paste Gemini API Key here (starts with AIza...)" onchange="saveApiKey()">
    </div>

    <div class="container">
        <div class="sidebar">
            <h3>Library Structure</h3>
            <div id="tree-root"></div>
        </div>

        <div class="main">
            <h3>Add New Paper</h3>
            <div class="btn-group">
                <input type="text" id="inputUrl" placeholder="Paste Paper URL or Abstract text here...">
                <button onclick="autoFillWithAI()">‚ú® Magic Fill (AI)</button>
            </div>

            <label>Title</label>
            <input type="text" id="title">
            
            <label>Hierarchy (Path)</label>
            <input type="text" id="path" placeholder="e.g. diffusion/post-training/distillation">
            
            <label>One-Sentence Summary</label>
            <textarea id="summary" rows="2"></textarea>

            <label>BibTeX</label>
            <textarea id="bibtex" rows="5" style="font-family: monospace;"></textarea>

            <div class="btn-group">
                <button onclick="savePaper()">üíæ Save Paper</button>
                <button class="secondary" onclick="clearForm()">Clear</button>
                <button class="secondary" onclick="exportBib()">‚¨áÔ∏è Export .bib</button>
            </div>
            
            <hr>
            
            <div id="paper-display">
                </div>
        </div>
    </div>

    <script>
        // --- DATA MANAGEMENT ---
        let papers = JSON.parse(localStorage.getItem('myPapers')) || [];
        
        // We read the key directly from the input now to avoid save errors
        function getApiKey() {
            return document.getElementById('apiKey').value || localStorage.getItem('geminiKey') || '';
        }

        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            if(key) {
                localStorage.setItem('geminiKey', key);
            }
        }

        // Initialize Input if key exists
        if(localStorage.getItem('geminiKey')) {
            document.getElementById('apiKey').value = localStorage.getItem('geminiKey');
        }

        function savePaper() {
            const title = document.getElementById('title').value;
            if (!title) return alert("Title is required!");

            const newPaper = {
                id: Date.now(),
                title: title,
                path: document.getElementById('path').value || 'Uncategorized',
                summary: document.getElementById('summary').value,
                bibtex: document.getElementById('bibtex').value,
                url: document.getElementById('inputUrl').value,
                added: new Date().toISOString()
            };

            const existingIndex = papers.findIndex(p => p.title === title);
            if (existingIndex > -1) papers.splice(existingIndex, 1);

            papers.push(newPaper);
            localStorage.setItem('myPapers', JSON.stringify(papers));
            renderTree();
            clearForm();
        }

        function loadPaper(id) {
            const paper = papers.find(p => p.id === id);
            if (!paper) return;
            document.getElementById('title').value = paper.title;
            document.getElementById('path').value = paper.path;
            document.getElementById('summary').value = paper.summary;
            document.getElementById('bibtex').value = paper.bibtex;
            document.getElementById('inputUrl').value = paper.url;
        }

        function exportBib() {
            const bibContent = papers.map(p => p.bibtex).join('\n\n');
            const blob = new Blob([bibContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'library.bib';
            a.click();
        }

        // --- TREE VIEW LOGIC ---
        function renderTree() {
            const root = document.getElementById('tree-root');
            root.innerHTML = '';
            const tree = {};
            papers.forEach(p => {
                const parts = p.path.split('/').map(s => s.trim()).filter(s => s);
                let current = tree;
                parts.forEach((part, i) => {
                    if (!current[part]) current[part] = { _files: [], _folders: {} };
                    if (i === parts.length - 1) current[part]._files.push(p);
                    current = current[part]._folders;
                });
            });

            function createNode(name, data, parentElement) {
                const container = document.createElement('div');
                container.className = 'tree-item';
                if (name) {
                    const title = document.createElement('div');
                    title.className = 'folder';
                    title.textContent = name;
                    container.appendChild(title);
                }
                if (data._files) {
                    data._files.forEach(f => {
                        const fileEl = document.createElement('span');
                        fileEl.className = 'file';
                        fileEl.textContent = 'üìÑ ' + f.title;
                        fileEl.onclick = () => loadPaper(f.id);
                        container.appendChild(fileEl);
                    });
                }
                if (data._folders) {
                    Object.keys(data._folders).forEach(key => {
                        createNode(key, { _files: [], _folders: data._folders[key]._folders, ...data._folders[key] }, container);
                    });
                }
                parentElement.appendChild(container);
            }
            Object.keys(tree).forEach(k => createNode(k, tree[k], root));
        }

        // --- AI INTEGRATION (FIXED) ---
        function toggleApiSettings() {
            const el = document.getElementById('api-section');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function autoFillWithAI() {
            saveApiKey(); // Ensure key is saved before running
            const apiKey = getApiKey();
            const input = document.getElementById('inputUrl').value;

            if (!apiKey) return alert("Please enter your Gemini API Key in the settings!");
            if (!input) return alert("Please enter a URL or abstract text.");

            const button = document.querySelector('button[onclick="autoFillWithAI()"]');
            const originalText = button.textContent;
            button.textContent = "ü§ñ Analyzing...";
            button.disabled = true;

            const prompt = `
            I have this paper input (URL or text): "${input}".
            Please extract or generate:
            1. The Title.
            2. A suggested taxonomy path (e.g. field/subfield) based on topic.
            3. A single sentence summary of the main contribution.
            4. A standard BibTeX citation.
            
            Return ONLY a valid JSON object with keys: title, path, summary, bibtex.
            DO NOT use markdown formatting like \`\`\`json. Just the raw JSON string.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                
                // --- ERROR CATCHING BLOCK ---
                if (data.error) {
                    throw new Error("Google API Error: " + data.error.message);
                }
                if (!data.candidates || data.candidates.length === 0) {
                     // Check for safety blocks
                     if (data.promptFeedback) {
                        throw new Error("Safety Block: " + JSON.stringify(data.promptFeedback));
                     }
                     throw new Error("No response from AI. Try pasting the Abstract text instead of the URL.");
                }
                // -----------------------------

                let text = data.candidates[0].content.parts[0].text;
                // Cleanup JSON if markdown blocks exist
                text = text.replace(/```json/g, '').replace(/```/g, '');
                
                const result = JSON.parse(text);
                
                document.getElementById('title').value = result.title;
                document.getElementById('path').value = result.path.toLowerCase().replace(/ /g, '_');
                document.getElementById('summary').value = result.summary;
                document.getElementById('bibtex').value = result.bibtex;
                
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function clearForm() {
            document.getElementById('title').value = '';
            document.getElementById('path').value = '';
            document.getElementById('summary').value = '';
            document.getElementById('bibtex').value = '';
            document.getElementById('inputUrl').value = '';
        }

        // Init
        renderTree();
    </script>
</body>
</html>
